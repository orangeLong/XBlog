<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Block源码解析 | XZero</title>
    <meta name="description" content="XZero&#39;s simple blog">
    
    
    <link rel="preload" href="/assets/css/0.styles.aefcf3a1.css" as="style"><link rel="preload" href="/assets/js/app.555c4bca.js" as="script"><link rel="preload" href="/assets/js/2.543e9615.js" as="script"><link rel="preload" href="/assets/js/5.91a8df96.js" as="script"><link rel="prefetch" href="/assets/js/10.029c5a8f.js"><link rel="prefetch" href="/assets/js/11.fee6cca9.js"><link rel="prefetch" href="/assets/js/12.ff33eda2.js"><link rel="prefetch" href="/assets/js/13.ae250377.js"><link rel="prefetch" href="/assets/js/14.751f98d9.js"><link rel="prefetch" href="/assets/js/3.db83979e.js"><link rel="prefetch" href="/assets/js/4.c1b4c741.js"><link rel="prefetch" href="/assets/js/6.f136f14e.js"><link rel="prefetch" href="/assets/js/7.fc7bfb03.js"><link rel="prefetch" href="/assets/js/8.9021f919.js"><link rel="prefetch" href="/assets/js/9.fc99a543.js">
    <link rel="stylesheet" href="/assets/css/0.styles.aefcf3a1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">XZero</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">XZero</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><span class="title">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/skill/iOS/effective.html" class="nav-link">iOS</a></li><li class="dropdown-item"><!----> <a href="/skill/Vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/skill/Node/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/skill/Base/" class="nav-link">Base</a></li></ul></div></div><div class="nav-item"><a href="/hole/recent.html" class="nav-link">树洞</a></div><div class="nav-item"><a href="https://github.com/orangeLong" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">XZero</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><span class="title">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/skill/iOS/effective.html" class="nav-link">iOS</a></li><li class="dropdown-item"><!----> <a href="/skill/Vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/skill/Node/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/skill/Base/" class="nav-link">Base</a></li></ul></div></div><div class="nav-item"><a href="/hole/recent.html" class="nav-link">树洞</a></div><div class="nav-item"><a href="https://github.com/orangeLong" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/skill/iOS/effective.html" class="sidebar-link">Effective Objective-C 2.0</a></li><li><a href="/skill/iOS/block.html" class="active sidebar-link">Block源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/skill/iOS/block.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/skill/iOS/block.html#block" class="sidebar-link">Block</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/skill/iOS/block.html#block类型" class="sidebar-link">Block类型</a></li><li class="sidebar-sub-header"><a href="/skill/iOS/block.html#block数据结构定义" class="sidebar-link">Block数据结构定义</a></li><li class="sidebar-sub-header"><a href="/skill/iOS/block.html#block-release" class="sidebar-link">Block_release()</a></li><li class="sidebar-sub-header"><a href="/skill/iOS/block.html#block的作用及实现" class="sidebar-link">__block的作用及实现</a></li><li class="sidebar-sub-header"><a href="/skill/iOS/block.html#block-object-assign" class="sidebar-link">Blockobject_assign</a></li><li class="sidebar-sub-header"><a href="/skill/iOS/block.html#block-object-dispose" class="sidebar-link">Blockobject_dispose</a></li></ul></li><li class="sidebar-sub-header"><a href="/skill/iOS/block.html#测试" class="sidebar-link">测试</a></li><li class="sidebar-sub-header"><a href="/skill/iOS/block.html#参考文献" class="sidebar-link">参考文献</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="block源码解析"><a href="#block源码解析" class="header-anchor">#</a> Block源码解析</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>  之前写过一篇block的文章，参考的源码是libclosure-38的，跟libclosure-67有所区别，且由于之前理解不足文章有些细小错误，决定重新写一篇。<br>
  关于Block的文章各个博客各个论坛都已经数不胜数，每一篇都有自己独特的特点和见解。但很多文章深度不够，只是简单的把一些源码放上去，并未分析每一步操作的作用，比较不友好，只能看得一知半解。笔者刚看的时候也是一头雾水，花费了很长时间查阅了各种资料才渐渐理解。鉴于此，决定写一篇事无巨细的文章来剖析Block的每一个步骤，来帮助大家理解Block的奥秘。<br>
  Block的使用这里就不再做过多解释，下面会通过分析源码来讲解Block的实现、变量的捕获以及__block的作用等。</p> <h2 id="block"><a href="#block" class="header-anchor">#</a> Block</h2> <h3 id="block类型"><a href="#block类型" class="header-anchor">#</a> Block类型</h3> <p>  看一段代码，以下在ARC下执行。</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">@</span>autoreleasepool <span class="token punctuation">{</span>
       <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
       <span class="token keyword">static</span> <span class="token keyword">int</span> staticNum <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
       <span class="token keyword">char</span> str<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
       <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>aBlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\n&quot;</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">;</span>
       <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>bBlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\n&quot;</span><span class="token punctuation">,</span> staticNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">;</span>
       <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>cBlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>word<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> word<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">;</span>
       <span class="token function">aBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">bBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">cBlock</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@----%@----%@----%@&quot;</span><span class="token punctuation">,</span> aBlock<span class="token punctuation">,</span> bBlock<span class="token punctuation">,</span> cBlock<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span><span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%d&quot;</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>打印结果如下:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;__NSMallocBlock__: 0x100607950&gt;----&lt;__NSGlobalBlock__: 0x100002118&gt;--
--&lt;__NSGlobalBlock__: 0x100002158&gt;----&lt;__NSStackBlock__: 0x7fff5fbff5c0&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>  其中因为bBlock和cBlock只使用了静态变量和入参，不需要捕获外部变量，所以为全局Block <code>__NSGlobalBlock__</code>，存在于全局区，内存在程序结束后由系统回收。最后一个使用了外部变量num，为栈Block<code>__NSStackBlock__</code>，内存由编译器控制，过了作用域就会被回收。而aBlock虽然也只使用了外部变量，但由于在ARC下会自动调用一次copy方法，将Block从栈区copy到堆区，所以aBlock为堆Block<code>__NSMallocBlock__</code>，内存由ARC控制，没有强指针指向时释放。而在MRC中，赋值不会执行copy操作，所以aBlock依然会存在于栈中，所以在MRC中一般都需要执行copy，否则很容易造成crash。<br>
  在ARC中，当Block作为属性被strong、copy修饰或被強指针应用或作为返回值时，都会默认执行copy方法。而MRC中，只有被copy修饰时，Block才会执行copy。所以MRC中Block都需要用copy来修饰，而在ARC中用copy修饰只是沿用了MRC的习惯，此时用copy和strong效果是相同的。下面会讲到copy的具体实现。</p> <h3 id="block数据结构定义"><a href="#block数据结构定义" class="header-anchor">#</a> Block数据结构定义</h3> <p>  Block的定义在<code>Block_private.h</code>中，<a href="https://opensource.apple.com/source/libclosure/libclosure-67" target="_blank" rel="noopener noreferrer">点击查看源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token comment">// Values for Block_layout-&gt;flags to describe block objects</span>
<span class="token keyword">enum</span> <span class="token punctuation">{</span>
    BLOCK_DEALLOCATING <span class="token operator">=</span>      <span class="token punctuation">(</span><span class="token number">0x0001</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// runtime  </span>
    BLOCK_REFCOUNT_MASK <span class="token operator">=</span>     <span class="token punctuation">(</span><span class="token number">0xfffe</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// runtime </span>
    BLOCK_NEEDS_FREE <span class="token operator">=</span>        <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// runtime </span>
    BLOCK_HAS_COPY_DISPOSE <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler </span>
    BLOCK_HAS_CTOR <span class="token operator">=</span>          <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler: helpers have C++ code</span>
    BLOCK_IS_GC <span class="token operator">=</span>             <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// runtime </span>
    BLOCK_IS_GLOBAL <span class="token operator">=</span>         <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler </span>
    BLOCK_USE_STRET <span class="token operator">=</span>         <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler: undefined if !BLOCK_HAS_SIGNATURE</span>
    BLOCK_HAS_SIGNATURE  <span class="token operator">=</span>    <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler </span>
    BLOCK_HAS_EXTENDED_LAYOUT<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">)</span>  <span class="token comment">// compiler </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> BLOCK_DESCRIPTOR_1 1</span>
<span class="token keyword">struct</span> Block_descriptor_1 <span class="token punctuation">{</span>
    uintptr_t reserved<span class="token punctuation">;</span>
    uintptr_t size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> BLOCK_DESCRIPTOR_2 1</span>
<span class="token keyword">struct</span> Block_descriptor_2 <span class="token punctuation">{</span>
    <span class="token comment">// requires BLOCK_HAS_COPY_DISPOSE</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>copy<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dispose<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> BLOCK_DESCRIPTOR_3 1</span>
<span class="token keyword">struct</span> Block_descriptor_3 <span class="token punctuation">{</span>
    <span class="token comment">// requires BLOCK_HAS_SIGNATURE</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>signature<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>layout<span class="token punctuation">;</span>     <span class="token comment">// contents depend on BLOCK_HAS_EXTENDED_LAYOUT</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> Block_layout <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>isa<span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> int32_t flags<span class="token punctuation">;</span> <span class="token comment">// contains ref count</span>
    int32_t reserved<span class="token punctuation">;</span> 
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>invoke<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> Block_descriptor_1 <span class="token operator">*</span>descriptor<span class="token punctuation">;</span>
    <span class="token comment">// imported variables</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>  用一张被用烂的图，<a href="http://www.galloway.me.uk/2013/05/a-look-inside-blocks-episode-3-block-copy/" target="_blank" rel="noopener noreferrer">点击查看原文<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。<br> <img src="/assets/img/structure.92445528.png" alt="结构图"><br>
  事实上该图适用于libclosure-38，在最新的源码中结构已经有所改变，但整体并未改变，只是在基础上新增了<code>signature</code>和<code>layout</code>，依然可以用其来理解。</p> <ul><li>isa指针
指向父类的结构体，就是<code>_NSConcreteStackBlock</code>，<code>_NSConcreteMallocBlock</code>，<code>_NSConcreteGlobalBlock</code>这几个，说明OC本身也是一个对象。</li> <li>flags
就是上面那几个枚举，用来保留block的一些信息，用到的如下：</li></ul> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">enum</span> <span class="token punctuation">{</span>
    BLOCK_DEALLOCATING <span class="token operator">=</span>      <span class="token punctuation">(</span><span class="token number">0x0001</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// runtime  </span>
    BLOCK_REFCOUNT_MASK <span class="token operator">=</span>     <span class="token punctuation">(</span><span class="token number">0xfffe</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// runtime 用来标识栈Block</span>
    BLOCK_NEEDS_FREE <span class="token operator">=</span>        <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// runtime  用来标识堆Block</span>
    BLOCK_HAS_COPY_DISPOSE <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler compiler 含有copy_dispose助手</span>
    BLOCK_IS_GLOBAL <span class="token operator">=</span>         <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler 是否为全局Block</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>BLOCK_REFCOUNT_MASK、BLOCK_IS_GLOBAL和BLOCK_NEEDS_FREE用来标识Block类型，BLOCK_HAS_COPY_DISPOSE判断Block是否有copy_dispose助手，即description2中的copy和dispose函数，用来管理捕获对象的内存，下面会细讲。</p> <ul><li>reserved
保留信息</li> <li>invoke
函数指针，指向block具体的执行函数</li> <li>description
block附加描述信息，主要保存了内存size以及copy和dispose函数的指针及签名和layout等信息，通过源码可发现，layout中只包含了Block_descriptor_1，并未包含Block_descriptor_2和Block_descriptor_3，这是因为在捕获不同类型变量或者没用到外部变量时，编译器会改变结构体的结构，按需添加Block_descriptor_2和Block_descriptor_3，所以才需要BLOCK_HAS_COPY_DISPOSE和BLOCK_HAS_SIGNATURE等枚举来判断</li> <li>variables capture的外部变量，如果Block中使用了外部变量，结构体中就会有相应的信息，下面会解释。Block将使用的变量或者变量指针copy过来，内部才可以访问。
###Block_byref的结构定义
  上面介绍了Block也就是<code>Block_layout</code>的源码，<code>Block_private.h</code>中还有定义了一个结构体<code>Block_byref</code>，变量在被__block修饰时由编译器来生成，结构如下：</li></ul> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">enum</span> <span class="token punctuation">{</span>
    <span class="token comment">// Byref refcount must use the same bits as Block_layout's refcount.</span>
    <span class="token comment">// BLOCK_DEALLOCATING =      (0x0001),  // runtime</span>
    <span class="token comment">// BLOCK_REFCOUNT_MASK =     (0xfffe),  // runtime</span>

    BLOCK_BYREF_LAYOUT_MASK <span class="token operator">=</span>       <span class="token punctuation">(</span><span class="token number">0xf</span> <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler</span>
    BLOCK_BYREF_LAYOUT_EXTENDED <span class="token operator">=</span>   <span class="token punctuation">(</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler</span>
    BLOCK_BYREF_LAYOUT_NON_OBJECT <span class="token operator">=</span> <span class="token punctuation">(</span>  <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler</span>
    BLOCK_BYREF_LAYOUT_STRONG <span class="token operator">=</span>     <span class="token punctuation">(</span>  <span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler</span>
    BLOCK_BYREF_LAYOUT_WEAK <span class="token operator">=</span>       <span class="token punctuation">(</span>  <span class="token number">4</span> <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler</span>
    BLOCK_BYREF_LAYOUT_UNRETAINED <span class="token operator">=</span> <span class="token punctuation">(</span>  <span class="token number">5</span> <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler</span>

    BLOCK_BYREF_IS_GC <span class="token operator">=</span>             <span class="token punctuation">(</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// runtime</span>

    BLOCK_BYREF_HAS_COPY_DISPOSE <span class="token operator">=</span>  <span class="token punctuation">(</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// compiler</span>
    BLOCK_BYREF_NEEDS_FREE <span class="token operator">=</span>        <span class="token punctuation">(</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// runtime</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> Block_byref <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>isa<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> Block_byref <span class="token operator">*</span>forwarding<span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> int32_t flags<span class="token punctuation">;</span> <span class="token comment">// contains ref count</span>
    uint32_t size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> Block_byref_2 <span class="token punctuation">{</span>
    <span class="token comment">// requires BLOCK_BYREF_HAS_COPY_DISPOSE</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>byref_keep<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Block_byref <span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token keyword">struct</span> Block_byref <span class="token operator">*</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>byref_destroy<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Block_byref <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> Block_byref_3 <span class="token punctuation">{</span>
    <span class="token comment">// requires BLOCK_BYREF_LAYOUT_EXTENDED</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>layout<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>  当其结构与<code>Block_layout</code>结构类似</p> <ul><li>isa指针
指向父类，一般直接指向0，后面会说。</li> <li>forwarding指针
在栈中指向自己，Block执行copy后指向堆中的byref。</li> <li>flags
runtime中用到的如下：</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>    BLOCK_BYREF_LAYOUT_EXTENDED =   (  1 &lt;&lt; 28), // compiler
    BLOCK_BYREF_HAS_COPY_DISPOSE =  (  1 &lt;&lt; 25), // compiler
    BLOCK_BYREF_NEEDS_FREE =        (  1 &lt;&lt; 24), // runtime
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>BLOCK_BYREF_LAYOUT_EXTENDED表示含有layout，BLOCK_BYREF_HAS_COPY_DISPOSE表示byref中含有copy_dispose函数，在__block捕获的变量为对象时就会生成copy_dispose函数用来管理对象内存，BLOCK_BYREF_NEEDS_FREE判断是否要释放。</p> <ul><li>size
所占内存大小</li> <li>Block_byref_2、Block_byref_3
Block_byref_2和Block_byref_3用来保存附加信息
###_NSConcreteGlobalBlock的实现
  使用Clang可以将OC转成C++，就可以看到Block具体做了什么。clang -rewrite-objc filename，比如我需要转换main.m中的代码就可以写clang -rewrite-objc main.m，注意路径正确。转换后的.cpp文件有10万行，只需要看最后几行。<br>
  上面说到，在block内部不使用外部变量或者为静态或者全局变量时，该block就是<code>_NSConcreteGlobalBlock</code>，看下编译后的结果。</li></ul> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">@</span>autoreleasepool <span class="token punctuation">{</span>
        <span class="token comment">// insert code here...</span>
        <span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hello block&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Clang后</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">struct</span> __block_impl <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>isa<span class="token punctuation">;</span>
  <span class="token keyword">int</span> Flags<span class="token punctuation">;</span>
  <span class="token keyword">int</span> Reserved<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>FuncPtr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//下面为转换后的代码</span>
<span class="token keyword">struct</span> __main_block_impl_0 <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> __block_impl impl<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> __main_block_desc_0<span class="token operator">*</span> Desc<span class="token punctuation">;</span>
  <span class="token function">__main_block_impl_0</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">struct</span> __main_block_desc_0 <span class="token operator">*</span>desc<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    impl<span class="token punctuation">.</span>isa <span class="token operator">=</span> <span class="token operator">&amp;</span>_NSConcreteStackBlock<span class="token punctuation">;</span>
    impl<span class="token punctuation">.</span>Flags <span class="token operator">=</span> flags<span class="token punctuation">;</span>
    impl<span class="token punctuation">.</span>FuncPtr <span class="token operator">=</span> fp<span class="token punctuation">;</span>
    Desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__main_block_func_0</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0 <span class="token operator">*</span>__cself<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hello block&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> __main_block_desc_0 <span class="token punctuation">{</span>
  size_t reserved<span class="token punctuation">;</span>
  size_t Block_size<span class="token punctuation">;</span>
<span class="token punctuation">}</span> __main_block_desc_0_DATA <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* @autoreleasepool */</span> <span class="token punctuation">{</span> __AtAutoreleasePool __autoreleasepool<span class="token punctuation">;</span> 

        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token function">__main_block_impl_0</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>__main_block_func_0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>__main_block_desc_0_DATA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>  从上可以看到，<code>__block_impl</code>、<code>__main_block_impl_0</code>以及<code>__main_block_desc_0</code>这三个结构体一起组成了整个Block，生成的结构体各个参数跟上面介绍的一致。编译器将Block内的函数定义成一个独立的函数<code>__main_block_func_0</code>，在最后调用。<br>
  不过有两点问题：</p> <ul><li>1、该Block并未使用外部变量，应该是一个_NSConcreteGlobalBlock，而用clang显示的却是_NSConcreteStackBlock，唐巧的说法是：clang 改写的具体实现方式和 LLVM 不太一样。这点不是很清楚，如果有了解的可以释疑一下。</li> <li>2、把编译后的代码copy到mm中后，<code>((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA))();</code>此行会crash，因为<code>((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA))</code>指向的是impl的isa，也就是_NSConcreteStackBlock的指针。需要改写成<code>struct __main_block_impl_0 impl_0 = __main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA); ((void (*)())(impl_0.impl.FuncPtr))();</code>才能执行成功。或许clang改写的实现跟LLVM确实不一样吧。
###_NSConcreteStackBlock的实现
  如果block内部使用了普通的外部变量，就是<code>_NSConcreteStackBlock</code>。</li></ul> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">@</span>autoreleasepool <span class="token punctuation">{</span>
        <span class="token comment">// insert code here...</span>

        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        NSObject <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSObject alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token operator">^</span><span class="token punctuation">{</span>
            obj<span class="token punctuation">,</span> a<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Clang后</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">struct</span> __block_impl <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>isa<span class="token punctuation">;</span>
  <span class="token keyword">int</span> Flags<span class="token punctuation">;</span>
  <span class="token keyword">int</span> Reserved<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>FuncPtr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//</span>
<span class="token keyword">struct</span> __main_block_impl_0 <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> __block_impl impl<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> __main_block_desc_0<span class="token operator">*</span> Desc<span class="token punctuation">;</span>
  NSObject <span class="token operator">*</span>obj<span class="token punctuation">;</span>
  <span class="token keyword">int</span> a<span class="token punctuation">;</span>
  <span class="token function">__main_block_impl_0</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">struct</span> __main_block_desc_0 <span class="token operator">*</span>desc<span class="token punctuation">,</span> NSObject <span class="token operator">*</span>_obj<span class="token punctuation">,</span> <span class="token keyword">int</span> _a<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">obj</span><span class="token punctuation">(</span>_obj<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">a</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    impl<span class="token punctuation">.</span>isa <span class="token operator">=</span> <span class="token operator">&amp;</span>_NSConcreteStackBlock<span class="token punctuation">;</span>
    impl<span class="token punctuation">.</span>Flags <span class="token operator">=</span> flags<span class="token punctuation">;</span>
    impl<span class="token punctuation">.</span>FuncPtr <span class="token operator">=</span> fp<span class="token punctuation">;</span>
    Desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__main_block_func_0</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0 <span class="token operator">*</span>__cself<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  NSObject <span class="token operator">*</span>obj <span class="token operator">=</span> __cself<span class="token operator">-&gt;</span>obj<span class="token punctuation">;</span> <span class="token comment">// bound by copy</span>
  <span class="token keyword">int</span> a <span class="token operator">=</span> __cself<span class="token operator">-&gt;</span>a<span class="token punctuation">;</span> <span class="token comment">// bound by copy</span>

            obj<span class="token punctuation">,</span> a<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__main_block_copy_0</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0<span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token keyword">struct</span> __main_block_impl_0<span class="token operator">*</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">_Block_object_assign</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dst<span class="token operator">-&gt;</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token operator">-&gt;</span>obj<span class="token punctuation">,</span> <span class="token number">3</span><span class="token comment">/*BLOCK_FIELD_IS_OBJECT*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__main_block_dispose_0</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0<span class="token operator">*</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">_Block_object_dispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token operator">-&gt;</span>obj<span class="token punctuation">,</span> <span class="token number">3</span><span class="token comment">/*BLOCK_FIELD_IS_OBJECT*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> __main_block_desc_0 <span class="token punctuation">{</span>
  size_t reserved<span class="token punctuation">;</span>
  size_t Block_size<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>copy<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> __main_block_impl_0<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dispose<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> __main_block_desc_0_DATA <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0<span class="token punctuation">)</span><span class="token punctuation">,</span> __main_block_copy_0<span class="token punctuation">,</span> __main_block_dispose_0<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* @autoreleasepool */</span> <span class="token punctuation">{</span> __AtAutoreleasePool __autoreleasepool<span class="token punctuation">;</span> 
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        NSObject <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>NSObject <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> SEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>objc_msgSend<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>NSObject <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> SEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>objc_msgSend<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token function">objc_getClass</span><span class="token punctuation">(</span><span class="token string">&quot;NSObject&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sel_registerName</span><span class="token punctuation">(</span><span class="token string">&quot;alloc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sel_registerName</span><span class="token punctuation">(</span><span class="token string">&quot;init&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token function">__main_block_impl_0</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>__main_block_func_0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>__main_block_desc_0_DATA<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">570425344</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>  该例在Block中同时使用了普通变量和实例变量，Block在捕获外部变量的操作基本一致，都是在生成结构体的时候将所有Block里用到的外部变量作为属性存起来。这就是为什么在self.block里调用self会造成循环引用，因为Block捕获了self并把self当做一个值保存了起来。<br>
  而且如果此时在Block里面改变a的值是会报错，因为普通变量的值传递为复制，所有Block里的a只是copy过去的a的值，在Block里改变a的值也不会影响外面，编译器避免这个错误就报错。同样的，捕获对象时也是对指针的copy，生成一个指针指向obj对象，所以如果在Block中直接让obj指针指向另外一个对象也会报错。这点编译器已经加了注释// bound by copy。<br>
  同时，该例与上例有所区别，多了<code>__main_block_copy_0</code>和<code>__main_block_dispose_0</code>这两个函数，并在描述<code>__main_block_desc_0</code>结构体中保存了这两个函数指针。这就是上面所说的copy_dispose助手，C语言结构体中，编译器很难处理对象的初始化和销毁操作，所以使用runtime来管理相关内存。<code>BLOCK_FIELD_IS_OBJECT</code>是在捕获对象时添加的特别标识，此时是3，下面会细讲。<br>
  此Block是为栈Block<code>_NSConcreteStackBlock</code>，不过在ARC中，因为赋值给aBlock，会执行一次copy，将其中栈中copy到堆中，所以在MRC中aBlock为<code>_NSConcreteStackBlock</code>，在ARC中就是<code>_NSConcreteMallocBlock</code>。
###_NSConcreteMallocBlock &amp;&amp; Block_copy()<br>
  上面说到，ARC中生成的<code>_NSConcreteStackBlock</code>在赋值给强指针时会默认执行一次copy变成<code>_NSConcreteMallocBlock</code>，下面介绍下copy的实现。<br>
  在<code>Block.h</code>中定义了Block_copy的宏</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token macro property">#<span class="token directive keyword">define</span> Block_copy(...) ((__typeof(__VA_ARGS__))_Block_copy((const void *)(__VA_ARGS__)))</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>  其实现在<code>runtime.h</code>中</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">_Block_copy</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1、</span>
    <span class="token keyword">struct</span> Block_layout <span class="token operator">*</span>aBlock<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arg<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token comment">//2、</span>
    <span class="token comment">// The following would be better done as a switch statement</span>
    aBlock <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Block_layout <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    <span class="token comment">//3、</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>aBlock<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BLOCK_NEEDS_FREE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// latches on high</span>
        <span class="token function">latching_incr_int</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>aBlock<span class="token operator">-&gt;</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> aBlock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//4、</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>aBlock<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BLOCK_IS_GLOBAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> aBlock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//5、</span>
        <span class="token comment">// Its a stack block.  Make a copy.</span>
        <span class="token keyword">struct</span> Block_layout <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>aBlock<span class="token operator">-&gt;</span>descriptor<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token comment">//6、</span>
        <span class="token function">memmove</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> aBlock<span class="token punctuation">,</span> aBlock<span class="token operator">-&gt;</span>descriptor<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bitcopy first</span>
        <span class="token comment">// reset refcount</span>
        <span class="token comment">//7、</span>
        result<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>BLOCK_REFCOUNT_MASK<span class="token operator">|</span>BLOCK_DEALLOCATING<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// XXX not needed</span>
        result<span class="token operator">-&gt;</span>flags <span class="token operator">|</span><span class="token operator">=</span> BLOCK_NEEDS_FREE <span class="token operator">|</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// logical refcount 1</span>
        <span class="token comment">//8、</span>
        <span class="token function">_Block_call_copy_helper</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> aBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Set isa last so memory analysis tools see a fully-initialized object.</span>
        <span class="token comment">//9、</span>
        result<span class="token operator">-&gt;</span>isa <span class="token operator">=</span> _NSConcreteMallocBlock<span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> int32_t <span class="token function">latching_incr_int</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> int32_t <span class="token operator">*</span>where<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        int32_t old_value <span class="token operator">=</span> <span class="token operator">*</span>where<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old_value <span class="token operator">&amp;</span> BLOCK_REFCOUNT_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> BLOCK_REFCOUNT_MASK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> BLOCK_REFCOUNT_MASK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">OSAtomicCompareAndSwapInt</span><span class="token punctuation">(</span>old_value<span class="token punctuation">,</span> old_value<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> where<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> old_value<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_Block_call_copy_helper</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>result<span class="token punctuation">,</span> <span class="token keyword">struct</span> Block_layout <span class="token operator">*</span>aBlock<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> Block_descriptor_2 <span class="token operator">*</span>desc <span class="token operator">=</span> <span class="token function">_Block_descriptor_2</span><span class="token punctuation">(</span>aBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>desc<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>desc<span class="token operator">-&gt;</span>copy<span class="token punctuation">)</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> aBlock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// do fixup</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> Block_descriptor_2 <span class="token operator">*</span> <span class="token function">_Block_descriptor_2</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Block_layout <span class="token operator">*</span>aBlock<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token punctuation">(</span>aBlock<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BLOCK_HAS_COPY_DISPOSE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    uint8_t <span class="token operator">*</span>desc <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span>aBlock<span class="token operator">-&gt;</span>descriptor<span class="token punctuation">;</span>
    desc <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Block_descriptor_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Block_descriptor_2 <span class="token operator">*</span><span class="token punctuation">)</span>desc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>  以上就是<code>_NSConcreteStackBlock</code>转换成<code>_NSConcreteMallocBlock</code>的过程，下面按步解释每一步的作用。</p> <ul><li>1、先声明一个<code>Block_layout</code>结构体类型的指针，如果传入的Block为NULL就直接返回。</li> <li>2、如果Block有值就强转成<code>Block_layout</code>的指针类型。</li> <li>3、如果Block的flags表明该Block为堆Block时，就对其引用计数递增，然后返回原Block。<code>latching_incr_int</code>这个函数进行了一次死循环，如果flags含有<code>BLOCK_REFCOUNT_MASK</code>证明其引用计数达到最大，直接返回，需要三万多个指针指向，正常情况下不会出现。随后做一次原子性判断其值当前是否被其他线程改动，如果被改动就进入下一次循环直到改动结束后赋值。<code>OSAtomicCompareAndSwapInt</code>的作用就是在<code>where</code>取值与<code>old_value</code>相同时，将<code>old_value+2</code>赋给<code>where</code>。  注:Block的引用计数以flags的后16位代表，以 2为单位，每次递增2，1被<code>BLOCK_DEALLOCATING</code>正在释放占用。</li> <li>4、如果Block为全局Block就不做其他处理直接返回。</li> <li>5、该else中就是栈Block了，按原Block的内存大小分配一块相同大小的内存，如果失败就返回NULL。</li> <li>6、memmove()用于复制位元，将aBlock的所有信息copy到result的位置上。</li> <li>7、将新Block的引用计数置零。<code>BLOCK_REFCOUNT_MASK|BLOCK_DEALLOCATING</code>就是<code>0xffff</code>，<code>~(0xffff)</code>就是<code>0x0000</code>，<code>result-&gt;flags</code>与<code>0x0000</code>与等就将<code>result-&gt;flags</code>的后16位置零。然后将新Block标识为堆Block并将其引用计数置为2。</li> <li>8、如果有copy_dispose助手，就执行Block的保存的copy函数，就是上面的<code>__main_block_copy_0</code>。在<code>_Block_descriptor_2</code>函数中，用<code>BLOCK_HAS_COPY_DISPOSE</code>来判断是否有<code>Block_descriptor_2</code>，且取Block的<code>Block_descriptor_2</code>时，因为有无是编译器确定的，在Block结构体中并无保留，所以需要使用指针相加的方式来确定其指针位置。有就执行，没有就return掉。</li> <li>9、将堆Block的isa指针置为<code>_NSConcreteMallocBlock</code>，返回新Block，end。
  因为在ARC中的赋值的自动copy，所以：</li></ul> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code>        NSObject <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSObject alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>aBlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">^</span><span class="token punctuation">{</span>
            obj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%ld&quot;</span><span class="token punctuation">,</span> <span class="token function">CFGetRetainCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bridge <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>  其打印结果为3，因为Block在生成栈Block捕获外部变量的时候会生成一份指针指向obj，在将Block赋值给aBlock时从栈中copy到堆区中，又持有了一份。</p> <h3 id="block-release"><a href="#block-release" class="header-anchor">#</a> Block_release()</h3> <p>  有<code>Block_copy()</code>就有对应的<code>Block_release()</code>，其在<code>Block.h</code>中的定义如下：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token macro property">#<span class="token directive keyword">define</span> Block_release(...) _Block_release((const void *)(__VA_ARGS__))</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>  其实现在<code>runtime.h</code>中</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">void</span> <span class="token function">_Block_release</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1、</span>
    <span class="token keyword">struct</span> Block_layout <span class="token operator">*</span>aBlock <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Block_layout <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aBlock<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">//2、</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>aBlock<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BLOCK_IS_GLOBAL<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">//3、</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token punctuation">(</span>aBlock<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BLOCK_NEEDS_FREE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">//4、</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">latching_decr_int_should_deallocate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>aBlock<span class="token operator">-&gt;</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//5、</span>
        <span class="token function">_Block_call_dispose_helper</span><span class="token punctuation">(</span>aBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//6、</span>
        <span class="token function">_Block_destructInstance</span><span class="token punctuation">(</span>aBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//7、</span>
        <span class="token function">free</span><span class="token punctuation">(</span>aBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> bool <span class="token function">latching_decr_int_should_deallocate</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> int32_t <span class="token operator">*</span>where<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        int32_t old_value <span class="token operator">=</span> <span class="token operator">*</span>where<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old_value <span class="token operator">&amp;</span> BLOCK_REFCOUNT_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> BLOCK_REFCOUNT_MASK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span> <span class="token comment">// latched high</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old_value <span class="token operator">&amp;</span> BLOCK_REFCOUNT_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>   <span class="token comment">// underflow, latch low</span>
        <span class="token punctuation">}</span>
        int32_t new_value <span class="token operator">=</span> old_value <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
        bool result <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old_value <span class="token operator">&amp;</span> <span class="token punctuation">(</span>BLOCK_REFCOUNT_MASK<span class="token operator">|</span>BLOCK_DEALLOCATING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            new_value <span class="token operator">=</span> old_value <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">OSAtomicCompareAndSwapInt</span><span class="token punctuation">(</span>old_value<span class="token punctuation">,</span> new_value<span class="token punctuation">,</span> where<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_Block_call_dispose_helper</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Block_layout <span class="token operator">*</span>aBlock<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> Block_descriptor_2 <span class="token operator">*</span>desc <span class="token operator">=</span> <span class="token function">_Block_descriptor_2</span><span class="token punctuation">(</span>aBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>desc<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>desc<span class="token operator">-&gt;</span>dispose<span class="token punctuation">)</span><span class="token punctuation">(</span>aBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_Block_destructInstance_default</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>aBlock __unused<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>_Block_destructInstance<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>aBlock<span class="token punctuation">)</span> <span class="token operator">=</span> _Block_destructInstance_default<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><ul><li>1、将入参arg强转成<code>(struct Block_layout *)</code>类型，如果入参为NULL则直接返回。</li> <li>2、如果入参为全局Block则返回不做处理。</li> <li>3、如果入参不为堆Block则返回不做处理。</li> <li>4、判断aBlock的引用计数是否需要释放内存。与copy同样的，<code>latching_decr_int_should_deallocate</code>也做了一次循环和原子性判断保证原子性。如果该block的引用计数过高(0xfffe)或者过低(0)返回false不做处理。如果其引用计数为2，则将其引用计数-1即<code>BLOCK_DEALLOCATING</code>标明正在释放，返回true，如果大于2则将其引用计数-2并返回false。</li> <li>5、如果步骤4标明了该block需要被释放，就进入步骤5。如果aBlock含有copy_dispose助手就执行aBlock中的dispose函数，与copy中的对应不再多做解释。</li> <li>6、<code>_Block_destructInstance</code>默认没做其他操作，可见源码。</li> <li>7、最后一步释放掉aBlock，end。</li></ul> <h3 id="block的作用及实现"><a href="#block的作用及实现" class="header-anchor">#</a> __block的作用及实现</h3> <p>  前面说到，Block捕获的变量不允许在内部改变指针指向，因为内部的对象是重新copy的一份指针或者普通变量值。如果需要改变普通变量的值或指针的指向，这个时候就需要用到__block。</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">@</span>autoreleasepool <span class="token punctuation">{</span>
        <span class="token comment">// insert code here...</span>
        __block <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        __block NSObject <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSObject alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token operator">^</span><span class="token punctuation">{</span>
            a<span class="token operator">++</span><span class="token punctuation">;</span>
            obj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Clang后</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__Block_byref_id_object_copy_131</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">_Block_object_assign</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>dst <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>src <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">131</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__Block_byref_id_object_dispose_131</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">_Block_object_dispose</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>src <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">131</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> __Block_byref_a_0 <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>__isa<span class="token punctuation">;</span>
__Block_byref_a_0 <span class="token operator">*</span>__forwarding<span class="token punctuation">;</span>
 <span class="token keyword">int</span> __flags<span class="token punctuation">;</span>
 <span class="token keyword">int</span> __size<span class="token punctuation">;</span>
 <span class="token keyword">int</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> __Block_byref_obj_1 <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>__isa<span class="token punctuation">;</span>
__Block_byref_obj_1 <span class="token operator">*</span>__forwarding<span class="token punctuation">;</span>
 <span class="token keyword">int</span> __flags<span class="token punctuation">;</span>
 <span class="token keyword">int</span> __size<span class="token punctuation">;</span>
 <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>__Block_byref_id_object_copy<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>__Block_byref_id_object_dispose<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 NSObject <span class="token operator">*</span>obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> __main_block_impl_0 <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> __block_impl impl<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> __main_block_desc_0<span class="token operator">*</span> Desc<span class="token punctuation">;</span>
  __Block_byref_a_0 <span class="token operator">*</span>a<span class="token punctuation">;</span> <span class="token comment">// by ref</span>
  __Block_byref_obj_1 <span class="token operator">*</span>obj<span class="token punctuation">;</span> <span class="token comment">// by ref</span>
  <span class="token function">__main_block_impl_0</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">struct</span> __main_block_desc_0 <span class="token operator">*</span>desc<span class="token punctuation">,</span> __Block_byref_a_0 <span class="token operator">*</span>_a<span class="token punctuation">,</span> __Block_byref_obj_1 <span class="token operator">*</span>_obj<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">a</span><span class="token punctuation">(</span>_a<span class="token operator">-&gt;</span>__forwarding<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">obj</span><span class="token punctuation">(</span>_obj<span class="token operator">-&gt;</span>__forwarding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    impl<span class="token punctuation">.</span>isa <span class="token operator">=</span> <span class="token operator">&amp;</span>_NSConcreteStackBlock<span class="token punctuation">;</span>
    impl<span class="token punctuation">.</span>Flags <span class="token operator">=</span> flags<span class="token punctuation">;</span>
    impl<span class="token punctuation">.</span>FuncPtr <span class="token operator">=</span> fp<span class="token punctuation">;</span>
    Desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__main_block_func_0</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0 <span class="token operator">*</span>__cself<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  __Block_byref_a_0 <span class="token operator">*</span>a <span class="token operator">=</span> __cself<span class="token operator">-&gt;</span>a<span class="token punctuation">;</span> <span class="token comment">// bound by ref</span>
  __Block_byref_obj_1 <span class="token operator">*</span>obj <span class="token operator">=</span> __cself<span class="token operator">-&gt;</span>obj<span class="token punctuation">;</span> <span class="token comment">// bound by ref</span>

            <span class="token punctuation">(</span>a<span class="token operator">-&gt;</span>__forwarding<span class="token operator">-&gt;</span>a<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>__forwarding<span class="token operator">-&gt;</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__main_block_copy_0</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0<span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token keyword">struct</span> __main_block_impl_0<span class="token operator">*</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">_Block_object_assign</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dst<span class="token operator">-&gt;</span>a<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token operator">-&gt;</span>a<span class="token punctuation">,</span> <span class="token number">8</span><span class="token comment">/*BLOCK_FIELD_IS_BYREF*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">_Block_object_assign</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dst<span class="token operator">-&gt;</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token operator">-&gt;</span>obj<span class="token punctuation">,</span> <span class="token number">8</span><span class="token comment">/*BLOCK_FIELD_IS_BYREF*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__main_block_dispose_0</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0<span class="token operator">*</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">_Block_object_dispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token operator">-&gt;</span>a<span class="token punctuation">,</span> <span class="token number">8</span><span class="token comment">/*BLOCK_FIELD_IS_BYREF*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">_Block_object_dispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token operator">-&gt;</span>obj<span class="token punctuation">,</span> <span class="token number">8</span><span class="token comment">/*BLOCK_FIELD_IS_BYREF*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> __main_block_desc_0 <span class="token punctuation">{</span>
  size_t reserved<span class="token punctuation">;</span>
  size_t Block_size<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>copy<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> __main_block_impl_0<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dispose<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> __main_block_desc_0_DATA <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> __main_block_impl_0<span class="token punctuation">)</span><span class="token punctuation">,</span> __main_block_copy_0<span class="token punctuation">,</span> __main_block_dispose_0<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* @autoreleasepool */</span> <span class="token punctuation">{</span> __AtAutoreleasePool __autoreleasepool<span class="token punctuation">;</span> 
        <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__blocks__</span><span class="token punctuation">(</span>byref<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> __Block_byref_a_0 a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>__Block_byref_a_0 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__Block_byref_a_0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__blocks__</span><span class="token punctuation">(</span>byref<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> __Block_byref_obj_1 obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>__Block_byref_obj_1 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>obj<span class="token punctuation">,</span> <span class="token number">33554432</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__Block_byref_obj_1<span class="token punctuation">)</span><span class="token punctuation">,</span> __Block_byref_id_object_copy_131<span class="token punctuation">,</span> __Block_byref_id_object_dispose_131<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>NSObject <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> SEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>objc_msgSend<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>NSObject <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> SEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>objc_msgSend<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token function">objc_getClass</span><span class="token punctuation">(</span><span class="token string">&quot;NSObject&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sel_registerName</span><span class="token punctuation">(</span><span class="token string">&quot;alloc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sel_registerName</span><span class="token punctuation">(</span><span class="token string">&quot;init&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token function">__main_block_impl_0</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>__main_block_func_0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>__main_block_desc_0_DATA<span class="token punctuation">,</span> <span class="token punctuation">(</span>__Block_byref_a_0 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token punctuation">(</span>__Block_byref_obj_1 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>obj<span class="token punctuation">,</span> <span class="token number">570425344</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>  可以看到加了__block的a和obj已经被编译成了两个结构体<code>__Block_byref_a_0</code>和<code>__Block_byref_obj_1</code>，这两个就是上面所说的<code>Block_byref</code>。可以看到起结构大同小异，都有__isa指针指向0，__forwarding指针指向自己，__flags用来标记，__size用来保存内存大小，a和obj指向最初的变量。可以发现，对象的结构体多了两个方法用来处理obj的内存。注释也变成了// bound by ref，这时候就可以修改变量a和对指针obj重新赋值。对象结构体比普通变量多了两个函数，用来处理NSOject的内存。<br>
  上面说Block捕获的对象会持有该对象，使其引用计数增加，然后看下__block修饰的对象会怎样。</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code>    __block NSObject <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSObject alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%ld---%p---%p&quot;</span><span class="token punctuation">,</span> <span class="token function">CFGetRetainCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bridge <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%ld---%p---%p&quot;</span><span class="token punctuation">,</span> <span class="token function">CFGetRetainCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bridge <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%ld---%p---%p&quot;</span><span class="token punctuation">,</span> <span class="token function">CFGetRetainCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bridge <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>打印结果如下:</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token number">1</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x60c000007d50</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x7fff5e913c28</span>
<span class="token number">1</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x60c000007d50</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x7fff5e913c28</span>
<span class="token number">1</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x60c000007d50</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x7fff5e913c28</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>  可以看到，在栈Block中，自始只有强指针指向obj，就是__block生成的结构体。<br>
  然后看下在copy到堆中的效果：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code>__block NSObject <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSObject alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%ld---%p---%p&quot;</span><span class="token punctuation">,</span> <span class="token function">CFGetRetainCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bridge <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>aBlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%ld---%p---%p&quot;</span><span class="token punctuation">,</span> <span class="token function">CFGetRetainCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bridge <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">aBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%ld---%p---%p&quot;</span><span class="token punctuation">,</span> <span class="token function">CFGetRetainCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bridge <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>结果如下：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token number">1</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x604000012ca0</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x7fff50631c28</span>
<span class="token number">1</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x604000012ca0</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x600000058c28</span>
<span class="token number">1</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x604000012ca0</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x600000058c28</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>  可以看到，obj的内存地址一直在栈中，而执行了BlockCopy后，obj指针的地址从栈变到了堆中，而obj的引用计数一直是1。在copy操作之后，结构体obj也被复制到了堆中，并断开栈中的obj结构体对obj对象的指向。那如果这个时候取栈中的obj不就有问题了？__forwarding就派上用场了，上面编译的结果发现，结构体对象在使用obj的时候会使用obj-&gt;__forwarding-&gt;obj，如果所有__forwarding都指向自己，这一步还有什么意义？栈Block在执行copy操作后，栈obj结构体的__forwarding就会指向copy到堆中的obj结构体。此时再取值，操作的就是同一份指针了。证明如下:</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code>        __block NSObject <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSObject alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%ld---%p---%p&quot;</span><span class="token punctuation">,</span> <span class="token function">CFGetRetainCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bridge <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>aBlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%ld---%p---%p&quot;</span><span class="token punctuation">,</span> <span class="token function">CFGetRetainCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bridge <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">aBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>bBlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>aBlock copy<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">bBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">aBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%ld---%p---%p&quot;</span><span class="token punctuation">,</span> <span class="token function">CFGetRetainCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bridge <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>注：该段在MRC下执行，否则栈Block赋值给aBlock就会默认执行copy操作变成堆block。
打印结果：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token number">1</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x1006229d0</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x7fff5fbff6b8</span>
<span class="token number">1</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x1006229d0</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x7fff5fbff6b8</span>
<span class="token number">1</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x1006229d0</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x100508c98</span>
<span class="token number">1</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x1006229d0</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x100508c98</span>
<span class="token number">1</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x1006229d0</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">0x100508c98</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>  由上可知，在copy之前，aBlock的打印结果都是初始化生成的指针，而copy之后打印就和bBlock的打印结果相同了。总结一下就是，在栈中的obj结构体__forwarding指向的就是栈中的自己，执行copy之后，会在堆中生成一份obj结构体并断开栈中对obj的引用，此时堆中的obj结构体__forwarding就指向自己，而栈中的__forwarding就指向堆中的obj结构体。下面也会通过分析源码来具体解释。</p> <h3 id="block-object-assign"><a href="#block-object-assign" class="header-anchor">#</a> _Block_object_assign</h3> <p>  虽然上面已经讲了很多，但细心的同学可以发现，在Clang后的代码中还有两个没有讲到，就是编译器生成的copy_dispose代码中调用的两个用来管理对象内存的函数<code>_Block_object_assign</code>和<code>_Block_object_dispose</code>。<br>
  然后先讲<code>_Block_object_assign</code>。大家可以在<code>Block.h</code>中看到：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code>BLOCK_EXPORT <span class="token keyword">void</span> <span class="token function">_Block_object_assign</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span><span class="token punctuation">)</span>
    <span class="token function">__OSX_AVAILABLE_STARTING</span><span class="token punctuation">(</span>__MAC_10_6<span class="token punctuation">,</span> __IPHONE_3_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>  其实现在<code>runtime.c</code>中，其中用到很多枚举，如果不懂其含义，很难理解其上面的代码，所以在此之前先解释下各种枚举所代表的意思。<br>
  其枚举定义在<code>Block_private.h</code>中：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token comment">// Values for _Block_object_assign() and _Block_object_dispose() parameters</span>
<span class="token keyword">enum</span> <span class="token punctuation">{</span>
    <span class="token comment">// see function implementation for a more complete description of these fields and combinations</span>
    BLOCK_FIELD_IS_OBJECT   <span class="token operator">=</span>  <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token comment">// id, NSObject, __attribute__((NSObject)), block, ...</span>
    BLOCK_FIELD_IS_BLOCK    <span class="token operator">=</span>  <span class="token number">7</span><span class="token punctuation">,</span>  <span class="token comment">// a block variable</span>
    BLOCK_FIELD_IS_BYREF    <span class="token operator">=</span>  <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token comment">// the on stack structure holding the __block variable</span>
    BLOCK_FIELD_IS_WEAK     <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>  <span class="token comment">// declared __weak, only used in byref copy helpers</span>
    BLOCK_BYREF_CALLER      <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token comment">// called from __block (byref) copy/dispose support routines.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">enum</span> <span class="token punctuation">{</span>
    BLOCK_ALL_COPY_DISPOSE_FLAGS <span class="token operator">=</span> 
        BLOCK_FIELD_IS_OBJECT <span class="token operator">|</span> BLOCK_FIELD_IS_BLOCK <span class="token operator">|</span> BLOCK_FIELD_IS_BYREF <span class="token operator">|</span>
        BLOCK_FIELD_IS_WEAK <span class="token operator">|</span> BLOCK_BYREF_CALLER
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li><code>BLOCK_FIELD_IS_OBJECT</code>OC对象类型;</li> <li><code>BLOCK_FIELD_IS_BLOCK</code>为另一个block；</li> <li><code>BLOCK_FIELD_IS_BYREF</code>为一个被__block修饰后生成的结构体；</li> <li><code>BLOCK_FIELD_IS_WEAK</code>被__weak修饰过的弱引用，只在<code>Block_byref</code>管理内部对象内存时使用，也就是<code>__block __weak id</code> ；</li> <li><code>BLOCK_BYREF_CALLER</code>在处理<code>Block_byref</code>内部对象内存的时候会加的一个额外标记，配合上面的枚举一起使用；</li> <li><code>BLOCK_ALL_COPY_DISPOSE_FLAGS</code>上述情况的整合，即以上都会包含copy_dispose助手。
  现在再看<code>_Block_object_assign</code>:</li></ul> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">void</span> <span class="token function">_Block_object_assign</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>destArg<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>object<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>dest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>destArg<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">os_assumes</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> BLOCK_ALL_COPY_DISPOSE_FLAGS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> BLOCK_FIELD_IS_OBJECT<span class="token punctuation">:</span>
        <span class="token comment">/*******
        id object = ...;
        [^{ object; } copy];
        ********/</span>
        <span class="token comment">//1.</span>
        <span class="token function">_Block_retain_object</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>dest <span class="token operator">=</span> object<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> BLOCK_FIELD_IS_BLOCK<span class="token punctuation">:</span>
        <span class="token comment">/*******
        void (^object)(void) = ...;
        [^{ object; } copy];
        ********/</span>
        <span class="token comment">//2.</span>
        <span class="token operator">*</span>dest <span class="token operator">=</span> <span class="token function">_Block_copy</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    
      <span class="token keyword">case</span> BLOCK_FIELD_IS_BYREF <span class="token operator">|</span> BLOCK_FIELD_IS_WEAK<span class="token punctuation">:</span>
      <span class="token keyword">case</span> BLOCK_FIELD_IS_BYREF<span class="token punctuation">:</span>
        <span class="token comment">/*******
         // copy the onstack __block container to the heap
         // Note this __weak is old GC-weak/MRC-unretained.
         // ARC-style __weak is handled by the copy helper directly.
         __block ... x;
         __weak __block ... x;
         [^{ x; } copy];
         ********/</span>
        <span class="token comment">//3.</span>
        <span class="token operator">*</span>dest <span class="token operator">=</span> <span class="token function">_Block_byref_copy</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        
      <span class="token keyword">case</span> BLOCK_BYREF_CALLER <span class="token operator">|</span> BLOCK_FIELD_IS_OBJECT<span class="token punctuation">:</span>
      <span class="token keyword">case</span> BLOCK_BYREF_CALLER <span class="token operator">|</span> BLOCK_FIELD_IS_BLOCK<span class="token punctuation">:</span>
        <span class="token comment">/*******
         // copy the actual field held in the __block container
         // Note this is MRC unretained __block only. 
         // ARC retained __block is handled by the copy helper directly.
         __block id object;
         __block void (^object)(void);
         [^{ object; } copy];
         ********/</span>
        <span class="token comment">//4.</span>
        <span class="token operator">*</span>dest <span class="token operator">=</span> object<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> BLOCK_BYREF_CALLER <span class="token operator">|</span> BLOCK_FIELD_IS_OBJECT <span class="token operator">|</span> BLOCK_FIELD_IS_WEAK<span class="token punctuation">:</span>
      <span class="token keyword">case</span> BLOCK_BYREF_CALLER <span class="token operator">|</span> BLOCK_FIELD_IS_BLOCK  <span class="token operator">|</span> BLOCK_FIELD_IS_WEAK<span class="token punctuation">:</span>
        <span class="token comment">/*******
         // copy the actual field held in the __block container
         // Note this __weak is old GC-weak/MRC-unretained.
         // ARC-style __weak is handled by the copy helper directly.
         __weak __block id object;
         __weak __block void (^object)(void);
         [^{ object; } copy];
         ********/</span>
        <span class="token comment">//5.</span>
        <span class="token operator">*</span>dest <span class="token operator">=</span> object<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_Block_retain_object_default</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr __unused<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>_Block_retain_object<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token operator">=</span> _Block_retain_object_default<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> Block_byref <span class="token operator">*</span><span class="token function">_Block_byref_copy</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//3.1</span>
    <span class="token keyword">struct</span> Block_byref <span class="token operator">*</span>src <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Block_byref <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>src<span class="token operator">-&gt;</span>forwarding<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BLOCK_REFCOUNT_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// src points to stack</span>
        <span class="token comment">//3.2</span>
        <span class="token keyword">struct</span> Block_byref <span class="token operator">*</span>copy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Block_byref <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>src<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        copy<span class="token operator">-&gt;</span>isa <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token comment">// byref value 4 is logical refcount of 2: one for caller, one for stack</span>
        <span class="token comment">//3.3</span>
        copy<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> src<span class="token operator">-&gt;</span>flags <span class="token operator">|</span> BLOCK_BYREF_NEEDS_FREE <span class="token operator">|</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token comment">//3.4</span>
        copy<span class="token operator">-&gt;</span>forwarding <span class="token operator">=</span> copy<span class="token punctuation">;</span> <span class="token comment">// patch heap copy to point to itself</span>
        src<span class="token operator">-&gt;</span>forwarding <span class="token operator">=</span> copy<span class="token punctuation">;</span>  <span class="token comment">// patch stack to point to heap copy</span>
        <span class="token comment">//3.5</span>
        copy<span class="token operator">-&gt;</span>size <span class="token operator">=</span> src<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BLOCK_BYREF_HAS_COPY_DISPOSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Trust copy helper to copy everything of interest</span>
            <span class="token comment">// If more than one field shows up in a byref block this is wrong XXX</span>
            <span class="token comment">//3.6</span>
            <span class="token keyword">struct</span> Block_byref_2 <span class="token operator">*</span>src2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Block_byref_2 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>src<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">struct</span> Block_byref_2 <span class="token operator">*</span>copy2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Block_byref_2 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>copy<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3.7</span>
            copy2<span class="token operator">-&gt;</span>byref_keep <span class="token operator">=</span> src2<span class="token operator">-&gt;</span>byref_keep<span class="token punctuation">;</span>
            copy2<span class="token operator">-&gt;</span>byref_destroy <span class="token operator">=</span> src2<span class="token operator">-&gt;</span>byref_destroy<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BLOCK_BYREF_LAYOUT_EXTENDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//3.8</span>
                <span class="token keyword">struct</span> Block_byref_3 <span class="token operator">*</span>src3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Block_byref_3 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>src2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">struct</span> Block_byref_3 <span class="token operator">*</span>copy3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Block_byref_3<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>copy2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                copy3<span class="token operator">-&gt;</span>layout <span class="token operator">=</span> src3<span class="token operator">-&gt;</span>layout<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//3.9</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>src2<span class="token operator">-&gt;</span>byref_keep<span class="token punctuation">)</span><span class="token punctuation">(</span>copy<span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Bitwise copy.</span>
            <span class="token comment">// This copy includes Block_byref_3, if any.</span>
            <span class="token comment">//3.10</span>
            <span class="token function">memmove</span><span class="token punctuation">(</span>copy<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> src<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> src<span class="token operator">-&gt;</span>size <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// already copied to heap</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>src<span class="token operator">-&gt;</span>forwarding<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BLOCK_BYREF_NEEDS_FREE<span class="token punctuation">)</span> <span class="token operator">==</span> BLOCK_BYREF_NEEDS_FREE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//3.11</span>
        <span class="token function">latching_incr_int</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>src<span class="token operator">-&gt;</span>forwarding<span class="token operator">-&gt;</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//3.12</span>
    <span class="token keyword">return</span> src<span class="token operator">-&gt;</span>forwarding<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br></div></div><p>  destArg为执行<code>Block_copy()</code>后的block中的对象、block、或者BYREF指针的指针，obj为copy之前的变量指针。</p> <ul><li>1、当block捕获的变量为OC对象时执行此步，ARC中引用计数由强指针来确定，所以<code>_Block_retain_object</code>默认是不做任何操作，只进行简单的指针赋值。</li> <li>2、当block捕获的变量为另外一个block时执行此步，copy一个新的block并赋值。</li> <li>3、当block捕获的变量为__block修饰的变量时会执行此步，执行byref_copy操作。
3.1、强转入参为<code>(struct Block_byref *)</code>类型。
3.2、当入参为栈byref时执行此步。分配一份与当前byref相同的内存，并将isa指针置为NULL。
3.3、将新byref的引用计数置为4并标记为堆，一份为调用方、一份为栈持有，所以引用计数为4。
3.4、然后将当前byref和malloc的byref的forwading都指向堆byref，然后操作堆栈都是同一份东西。
3.5、最后将size赋值
3.6、如果byref含有需要内存管理的变量即有copy_dispose助手，执行此步。分别取出src的<code>Block_byref_2</code>和copy的<code>Block_byref_2</code>。
3.7、将src的管理内存函数指针赋值给copy。
3.8、如果src含有<code>Block_byref_3</code>，则将src的<code>Block_byref_3</code>赋值给copy。
3.9、执行byref的<code>byref_keep</code>函数(即<code>_Block_object_assign</code>，不过会加上<code>BLOCK_BYREF_CALLER</code>标记)，管理捕获的对象内存。
3.10、如果捕获的是普通变量，就没有<code>Block_byref_2</code>，copy+1和src+1指向的就是<code>Block_byref_3</code>，执行字节拷贝。
3.11、如果该byref是存在于堆，则只需要增加其引用计数。
3.12、返回forwarding。</li> <li>4、如果管理的是__block修饰的对象或者block的内存会执行此步，直接进行指针赋值。</li> <li>5、同时被__weak和__block修饰的对象或者block执行此步，也是直接进行指针赋值。</li></ul> <h3 id="block-object-dispose"><a href="#block-object-dispose" class="header-anchor">#</a> _Block_object_dispose</h3> <p>  与<code>_Block_object_assign</code>对应的。</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">void</span> <span class="token function">_Block_object_dispose</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>object<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">os_assumes</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> BLOCK_ALL_COPY_DISPOSE_FLAGS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> BLOCK_FIELD_IS_BYREF <span class="token operator">|</span> BLOCK_FIELD_IS_WEAK<span class="token punctuation">:</span>
      <span class="token keyword">case</span> BLOCK_FIELD_IS_BYREF<span class="token punctuation">:</span>
        <span class="token comment">// get rid of the __block data structure held in a Block</span>
        <span class="token comment">//1.</span>
        <span class="token function">_Block_byref_release</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> BLOCK_FIELD_IS_BLOCK<span class="token punctuation">:</span>
        <span class="token comment">//2.</span>
        <span class="token function">_Block_release</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> BLOCK_FIELD_IS_OBJECT<span class="token punctuation">:</span>
        <span class="token comment">//3.</span>
        <span class="token function">_Block_release_object</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">//4.</span>
      <span class="token keyword">case</span> BLOCK_BYREF_CALLER <span class="token operator">|</span> BLOCK_FIELD_IS_OBJECT<span class="token punctuation">:</span>
      <span class="token keyword">case</span> BLOCK_BYREF_CALLER <span class="token operator">|</span> BLOCK_FIELD_IS_BLOCK<span class="token punctuation">:</span>
      <span class="token keyword">case</span> BLOCK_BYREF_CALLER <span class="token operator">|</span> BLOCK_FIELD_IS_OBJECT <span class="token operator">|</span> BLOCK_FIELD_IS_WEAK<span class="token punctuation">:</span>
      <span class="token keyword">case</span> BLOCK_BYREF_CALLER <span class="token operator">|</span> BLOCK_FIELD_IS_BLOCK  <span class="token operator">|</span> BLOCK_FIELD_IS_WEAK<span class="token punctuation">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_Block_byref_release</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1.1</span>
    <span class="token keyword">struct</span> Block_byref <span class="token operator">*</span>byref <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Block_byref <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>

    <span class="token comment">// dereference the forwarding pointer since the compiler isn't doing this anymore (ever?)</span>
    byref <span class="token operator">=</span> byref<span class="token operator">-&gt;</span>forwarding<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>byref<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BLOCK_BYREF_NEEDS_FREE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.2</span>
        int32_t refcount <span class="token operator">=</span> byref<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BLOCK_REFCOUNT_MASK<span class="token punctuation">;</span>
        <span class="token function">os_assert</span><span class="token punctuation">(</span>refcount<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">latching_decr_int_should_deallocate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>byref<span class="token operator">-&gt;</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//1.3</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>byref<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BLOCK_BYREF_HAS_COPY_DISPOSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//1.4</span>
                <span class="token keyword">struct</span> Block_byref_2 <span class="token operator">*</span>byref2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Block_byref_2 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>byref<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span>byref2<span class="token operator">-&gt;</span>byref_destroy<span class="token punctuation">)</span><span class="token punctuation">(</span>byref<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//1.5</span>
            <span class="token function">free</span><span class="token punctuation">(</span>byref<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_Block_release_object_default</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr __unused<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>_Block_release_object<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token operator">=</span> _Block_release_object_default<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><ul><li>1、如果需要管理的变量为byref，则执行该步。
1.1、将入参强转成<code>(struct Block_byref *)</code>，并将入参替换成forwarding。
1.2、如果该byref在堆上执行此步，如果该byref还被标记为栈则执行断言。
1.3、此函数上面有讲就不多提，判断是否需要释放内存。
1.4、如果有copy_dispose助手就执行byref_destroy管理捕获的变量内存。
1.5、释放byref。</li> <li>2、如果block则调用<code>_Block_release</code>释放block，上面有讲。</li> <li>3、如果是OC对象就进行release，默认没有做操作，由ARC管理。</li> <li>4、如果是其他就不做处理，__block修饰的变量只有一个强指针引用。</li></ul> <h2 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h2> <p>  如果这么长都看完了，想必你已经对block有了深刻的认识，来波测试吧(本文只有此测试是抄的)。下面的选项均为：A、ARC可以正常执行。B、ARC和MRC均可以正常执行。C、均不可正常执行。</p> <h6 id="example-a"><a href="#example-a" class="header-anchor">#</a> Example A</h6> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">void</span> <span class="token function">exampleA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> a <span class="token operator">=</span> <span class="token string">'A'</span><span class="token punctuation">;</span>
  <span class="token operator">^</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%c\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h6 id="example-b"><a href="#example-b" class="header-anchor">#</a> Example B</h6> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">void</span> <span class="token function">exampleB_addBlockToArray</span><span class="token punctuation">(</span>NSMutableArray <span class="token operator">*</span>array<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> b <span class="token operator">=</span> <span class="token string">'B'</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span>array addObject<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%c\n&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">exampleB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  NSMutableArray<span class="token operator">*</span>array <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableArray array<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">exampleB_addBlockToArray</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>block<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>array objectAtIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h6 id="example-c"><a href="#example-c" class="header-anchor">#</a> Example C</h6> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">void</span> <span class="token function">exampleC_addBlockToArray</span><span class="token punctuation">(</span>NSMutableArray <span class="token operator">*</span>array<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>array addObject<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;C\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">exampleC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  NSMutableArray <span class="token operator">*</span>array <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableArray array<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">exampleC_addBlockToArray</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>block<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>array objectAtIndex<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h6 id="example-d"><a href="#example-d" class="header-anchor">#</a> Example D</h6> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">typedef</span> <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>dBlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

dBlock <span class="token function">exampleD_getBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> d <span class="token operator">=</span> <span class="token string">'D'</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token operator">^</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%c\n&quot;</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">exampleD</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">exampleD_getBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h6 id="example-e"><a href="#example-e" class="header-anchor">#</a> Example E</h6> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">typedef</span> <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>eBlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

eBlock <span class="token function">exampleE_getBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> e <span class="token operator">=</span> <span class="token string">'E'</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>block<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">^</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%c\n&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> block<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">exampleE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  eBlock block <span class="token operator">=</span> <span class="token function">exampleE_getBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>  答案？不存在的！看在辛苦码这么字的份上，先star一发我就发咯。</p> <h2 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h2> <p><a href="https://opensource.apple.com/source/libclosure/libclosure-67/Block_private.h.auto.html" target="_blank" rel="noopener noreferrer">apple源码地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="http://www.galloway.me.uk/2013/05/a-look-inside-blocks-episode-3-block-copy/" target="_blank" rel="noopener noreferrer">参考文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/skill/iOS/effective.html" class="prev">Effective Objective-C 2.0</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.555c4bca.js" defer></script><script src="/assets/js/2.543e9615.js" defer></script><script src="/assets/js/5.91a8df96.js" defer></script>
  </body>
</html>
